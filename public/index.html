<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>Ranmem</title>

<script src="https://cdn.jsdelivr.net/npm/shaka-player/dist/shaka-player.compiled.js"></script>

<style>
*{box-sizing:border-box;font-family:system-ui}
body{
  margin:0;
  background:#0f0f0f;
  color:#fff;
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:#151515;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
}
button{
  background:#222;
  color:#fff;
  border:0;
  padding:6px 10px;
  cursor:pointer;
}
main{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
video{
  max-width:95%;
  max-height:80vh;
  background:black;
}
#title{
  margin-top:8px;
  opacity:.85;
}

/* SETTINGS */
#settings{
  display:none;
  background:#111;
  padding:12px;
}
.sub{
  border:1px solid #222;
  padding:8px;
  margin-bottom:8px;
}
.sub input,
.sub textarea{
  width:100%;
  background:#222;
  color:#fff;
  border:0;
  padding:6px;
  margin-top:4px;
}
.sub button{
  background:#400;
  margin-top:6px;
}
.actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
</style>
</head>

<body>

<header>
  <b>Ranmem</b>
  <button onclick="toggleSettings()">⚙</button>
</header>

<div id="settings">
  <div id="subs"></div>
  <button onclick="addSub()">＋ Sub ekle</button>

  <div class="actions">
    <label><input type="checkbox" id="onlyVideo"> Sadece video</label>
    <label><input type="checkbox" id="nsfw"> NSFW</label>
  </div>

  <div class="actions">
    <button onclick="saveSettings()">Yenile / Uygula</button>
  </div>
</div>

<main ondblclick="loadMeme()">
  <video id="video" autoplay muted></video>
  <div id="title"></div>
</main>

<script>
const video = document.getElementById("video");
const titleEl = document.getElementById("title");
const subsBox = document.getElementById("subs");
const onlyVideoEl = document.getElementById("onlyVideo");
const nsfwEl = document.getElementById("nsfw");

const player = new shaka.Player(video);

let settings = {
  subs:[
    { name:"vlandiya", flairs:["shitpost","Meme/Mizah"] },
    { name:"indirilenler", flairs:[] }
  ],
  onlyVideo:true,
  nsfw:false
};

const seen = new Set();

/* SETTINGS */

function toggleSettings(){
  const s = document.getElementById("settings");
  s.style.display = s.style.display === "none" ? "block" : "none";
}

function renderSettings(){
  subsBox.innerHTML="";
  settings.subs.forEach((s,i)=>{
    const d=document.createElement("div");
    d.className="sub";
    d.innerHTML=`
      <input value="${s.name}">
      <textarea>${s.flairs.join(", ")}</textarea>
      <button onclick="removeSub(${i})">Sil</button>
    `;
    subsBox.appendChild(d);
  });
  onlyVideoEl.checked=settings.onlyVideo;
  nsfwEl.checked=settings.nsfw;
}

function addSub(){
  settings.subs.push({name:"",flairs:[]});
  renderSettings();
}

function removeSub(i){
  settings.subs.splice(i,1);
  renderSettings();
}

function saveSettings(){
  const subs=[];
  document.querySelectorAll(".sub").forEach(d=>{
    const name=d.querySelector("input").value.trim();
    const flairs=d.querySelector("textarea").value
      .split(",").map(f=>f.trim()).filter(Boolean);
    if(name) subs.push({name,flairs});
  });

  settings={
    subs,
    onlyVideo:onlyVideoEl.checked,
    nsfw:nsfwEl.checked
  };

  localStorage.setItem("ranmem_settings",JSON.stringify(settings));
  toggleSettings();
  seen.clear();
  loadMeme();
}

function loadFromStorage(){
  const s=localStorage.getItem("ranmem_settings");
  if(s) settings=JSON.parse(s);
  renderSettings();
}

/* LOAD MEME */

async function loadMeme(){
  if(!settings.subs.length) return;
  titleEl.textContent="Yükleniyor…";

  const sub=settings.subs[Math.floor(Math.random()*settings.subs.length)];

  const r=await fetch(`/api/reddit?sub=${sub.name}&limit=50`);
  const j=await r.json();

  const posts=j.data.children
    .map(c=>c.data)
    .filter(p=>{
      if(seen.has(p.id)) return false;
      if(!settings.nsfw && p.over_18) return false;
      if(settings.onlyVideo && !p.is_video) return false;
      if(sub.flairs.length && !sub.flairs.includes(p.link_flair_text)) return false;
      return p.is_video && p.media?.reddit_video?.dash_url;
    });

  if(!posts.length) return loadMeme();

  const post=posts[Math.floor(Math.random()*posts.length)];
  seen.add(post.id);
  titleEl.textContent=post.title;

  const dash = "/api/dash?url=" + encodeURIComponent(post.media.reddit_video.dash_url);
  await player.load(dash);
  video.muted=false;
  video.play().catch(()=>{});
}

loadFromStorage();
loadMeme();
</script>

</body>
</html>
